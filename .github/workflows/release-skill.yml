name: Release Skill

on:
  workflow_dispatch:
    inputs:
      oci_ref:
        description: OCI reference to publish (for example ghcr.io/org/skill:0.1.0)
        required: true
        type: string

permissions:
  contents: read

jobs:
  release-skill:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
      packages: write
    env:
      OCI_REF: ${{ inputs.oci_ref }}
      COSIGN_YES: "true"
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd

      - name: Install Rust
        uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7

      - name: Cache Cargo
        uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5

      - name: Run conformance
        run: cargo conformance

      - name: Run inactu-cli tests
        run: cargo test -p inactu-cli

      - name: Prepare demo bundle artifact
        run: |
          mkdir -p dist
          cp test-vectors/good/pack-sign-roundtrip/skill.wasm dist/skill.wasm
          cp test-vectors/good/pack-sign-roundtrip/manifest.json dist/manifest.json
          cp test-vectors/good/pack-sign-roundtrip/signatures.json dist/signatures.json

      - name: Install ORAS
        uses: oras-project/setup-oras@22ce207df3b08e061f537244349aac6ae1d214f6

      - name: Install Syft
        uses: anchore/sbom-action/download-syft@28d71544de8eaf1b958d335707167c5f783590ad

      - name: Install Trivy
        uses: aquasecurity/setup-trivy@3fb12ec12f41e471780db15c232d5dd185dcb514

      - name: Install Cosign
        uses: sigstore/cosign-installer@faadad0cce49287aee09b3a48701e75088a2c6ad

      - name: Generate SPDX SBOM
        run: syft dir:./dist -o spdx-json > dist/sbom.spdx.json

      - name: Vulnerability gate
        run: trivy fs --exit-code 1 --severity HIGH,CRITICAL ./dist

      - name: Log in to GHCR
        run: echo "${{ github.token }}" | oras login ghcr.io -u "${{ github.actor }}" --password-stdin

      - name: Push OCI artifact
        run: |
          oras push "$OCI_REF" \
            --artifact-type application/vnd.inactu.bundle.v1 \
            dist/skill.wasm:application/wasm \
            dist/manifest.json:application/json \
            dist/signatures.json:application/json

      - name: Attach SBOM
        run: oras attach "$OCI_REF" --artifact-type application/spdx+json dist/sbom.spdx.json

      - name: Sign OCI artifact
        run: cosign sign "$OCI_REF"

      - name: Verify OCI artifact signature
        run: cosign verify "$OCI_REF"
